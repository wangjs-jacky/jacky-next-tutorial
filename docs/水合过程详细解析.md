# æ°´åˆè¿‡ç¨‹è¯¦ç»†è§£æ

## ğŸ¯ å®Œæ•´æµç¨‹è§£æ

### 1. æœåŠ¡ç«¯è¿”å›çš„ HTML æ•°æ®

#### æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML

```typescript
// app/counter/page.tsx
'use client';

import { useState } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);
  return (
    <div>
      <h1>Counter</h1>
      <button onClick={() => setCount(count + 1)}>
        Count: {count}
      </button>
    </div>
  );
}
```

**æœåŠ¡ç«¯ç”Ÿæˆçš„ HTML**ï¼š
```html
<!DOCTYPE html>
<html>
<head>
  <title>Counter</title>
</head>
<body>
  <div id="__next">
    <div>
      <h1>Counter</h1>
      <button>Count: 0</button>
    </div>
  </div>
  
  <!-- React è„šæœ¬ -->
  <script src="/_next/static/chunks/main.js"></script>
  <script>
    // React æ°´åˆæ‰€éœ€çš„æ•°æ®
    self.__next_data__ = {
      props: {
        pageProps: {}
      },
      page: "/counter"
    };
  </script>
</body>
</html>
```

**å…³é”®ç‚¹**ï¼š
- HTML æ˜¯é™æ€çš„ï¼Œæ²¡æœ‰ JavaScript åŠŸèƒ½
- åŒ…å« React æ°´åˆæ‰€éœ€çš„æ•°æ®
- DOM ç»“æ„å·²ç»å­˜åœ¨

### 2. createFiberRoot(container) è¯¦è§£

#### container æ˜¯ä»€ä¹ˆï¼Ÿ

```javascript
// container æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„ DOM å®¹å™¨
const container = document.getElementById('__next');
// container = <div id="__next">...</div>
```

#### createFiberRoot çš„ä½œç”¨

```javascript
function createFiberRoot(container) {
  // 1. åˆ›å»ºæ ¹ Fiber èŠ‚ç‚¹
  const rootFiber = {
    // å®¹å™¨ DOM èŠ‚ç‚¹
    containerInfo: container,  // <div id="__next">
    
    // å½“å‰æ¸²æŸ“çš„ Fiber æ ‘
    current: null,
    
    // å¾…å¤„ç†çš„æ›´æ–°é˜Ÿåˆ—
    pendingProps: null,
    
    // å…¶ä»–å…ƒæ•°æ®
    tag: 1,  // HostRoot
    mode: 0, // NoMode
  };
  
  // 2. åˆ›å»ºåˆå§‹çš„ HostRoot Fiber
  const uninitializedFiber = createHostRootFiber();
  rootFiber.current = uninitializedFiber;
  uninitializedFiber.stateNode = rootFiber;
  
  return rootFiber;
}
```

**å…³é”®ç†è§£**ï¼š
- `container` æ˜¯**æœåŠ¡ç«¯æ¸²æŸ“çš„ DOM å®¹å™¨**ï¼ˆ`<div id="__next">`ï¼‰
- `createFiberRoot` åˆ›å»ºçš„æ˜¯**ç©ºçš„ Fiber æ ¹èŠ‚ç‚¹**
- æ­¤æ—¶è¿˜æ²¡æœ‰å…³è”æœåŠ¡ç«¯çš„ DOM èŠ‚ç‚¹

### 3. linkDOMToFiber è¯¦è§£

#### å¦‚ä½•å»ºç«‹å…³è”ï¼Ÿ

```javascript
function linkDOMToFiber(container, fiberRoot) {
  // 1. è·å–æœåŠ¡ç«¯æ¸²æŸ“çš„ DOM æ ‘
  const serverDOM = container;  // <div id="__next">...</div>
  
  // 2. åˆ›å»ºå®¢æˆ·ç«¯ç»„ä»¶æ ‘ï¼ˆè™šæ‹Ÿ DOMï¼‰
  const clientElement = <Counter />;  // React å…ƒç´ 
  
  // 3. é€’å½’å»ºç«‹å…³è”
  function linkNode(domNode, fiberNode) {
    // 3.1 å»ºç«‹åŒå‘å…³è”
    fiberNode.stateNode = domNode;      // Fiber â†’ DOM
    domNode.__reactFiber = fiberNode;    // DOM â†’ Fiber
    
    // 3.2 å¤„ç†å­èŠ‚ç‚¹
    let childDOM = domNode.firstChild;
    let childFiber = fiberNode.child;
    
    while (childDOM && childFiber) {
      linkNode(childDOM, childFiber);
      childDOM = childDOM.nextSibling;
      childFiber = childFiber.sibling;
    }
  }
  
  // 4. ä»æ ¹èŠ‚ç‚¹å¼€å§‹å…³è”
  linkNode(serverDOM, fiberRoot.current);
}
```

**å…³é”®ç†è§£**ï¼š
- `linkDOMToFiber` ä¸æ˜¯"é‡æ–°ä¿®æ”¹" Fiber æ ‘
- è€Œæ˜¯**å°†æœåŠ¡ç«¯ DOM æ ‘å’Œå®¢æˆ·ç«¯ç»„ä»¶æ ‘å…³è”èµ·æ¥**
- å»ºç«‹åŒå‘å¼•ç”¨å…³ç³»

### 4. å®Œæ•´çš„æ°´åˆè¿‡ç¨‹

#### æ­¥éª¤ 1: å®¢æˆ·ç«¯æ¥æ”¶ HTML

```javascript
// æµè§ˆå™¨æ¥æ”¶åˆ° HTML
const html = `
  <div id="__next">
    <div>
      <h1>Counter</h1>
      <button>Count: 0</button>
    </div>
  </div>
`;

// æµè§ˆå™¨è§£æ HTMLï¼Œåˆ›å»º DOM æ ‘
const container = document.getElementById('__next');
// container = <div id="__next">...</div>
```

#### æ­¥éª¤ 2: React å¼€å§‹æ°´åˆ

```javascript
// React ä»£ç 
import { Counter } from './Counter';

// 1. åˆ›å»º Fiber æ ¹èŠ‚ç‚¹
const fiberRoot = createFiberRoot(container);
// fiberRoot = {
//   containerInfo: <div id="__next">,
//   current: HostRootFiber,
//   ...
// }

// 2. åˆ›å»ºå®¢æˆ·ç«¯ç»„ä»¶æ ‘ï¼ˆè™šæ‹Ÿ DOMï¼‰
const clientElement = <Counter />;
// clientElement = {
//   type: Counter,
//   props: {},
//   ...
// }
```

#### æ­¥éª¤ 3: å»ºç«‹å…³è”

```javascript
// 3. å»ºç«‹ DOM â†” Fiber å…³è”
linkDOMToFiber(container, fiberRoot);

// è¿‡ç¨‹ï¼š
// 1. éå†æœåŠ¡ç«¯ DOM æ ‘
// 2. åŒæ—¶éå†å®¢æˆ·ç«¯ç»„ä»¶æ ‘
// 3. å»ºç«‹ä¸€ä¸€å¯¹åº”å…³ç³»

// ç»“æœï¼š
// <div id="__next">.__reactFiber = rootFiber
// <h1>.__reactFiber = h1Fiber
// <button>.__reactFiber = buttonFiber
```

#### æ­¥éª¤ 4: åˆå§‹åŒ–çŠ¶æ€

```javascript
// 4. åˆå§‹åŒ–ç»„ä»¶çŠ¶æ€
initializeState(fiberRoot);

// è¿‡ç¨‹ï¼š
// 1. æ‰¾åˆ° Counter ç»„ä»¶çš„ Fiber èŠ‚ç‚¹
// 2. åˆå§‹åŒ– useState(0) çš„çŠ¶æ€
// 3. å­˜å‚¨ setCount å‡½æ•°

// ç»“æœï¼š
// counterFiber.memoizedState = { count: 0 }
// counterFiber.updateQueue = [{ setCount: handler }]
```

#### æ­¥éª¤ 5: æ·»åŠ äº‹ä»¶ç›‘å¬å™¨

```javascript
// 5. æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
attachEventListeners(fiberRoot);

// è¿‡ç¨‹ï¼š
// 1. æ‰¾åˆ° <button> çš„ Fiber èŠ‚ç‚¹
// 2. è·å– onClick å±æ€§
// 3. æ·»åŠ äº‹ä»¶ç›‘å¬å™¨

// ç»“æœï¼š
// <button>.addEventListener('click', onClickHandler)
```

## ğŸ” è¯¦ç»†ä»£ç è§£æ

### å®Œæ•´çš„ hydrateRoot å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
function hydrateRoot(container, element) {
  // ========== æ­¥éª¤ 1: åˆ›å»º Fiber æ ¹èŠ‚ç‚¹ ==========
  // container: æœåŠ¡ç«¯æ¸²æŸ“çš„ DOM å®¹å™¨ (<div id="__next">)
  // element: å®¢æˆ·ç«¯ React ç»„ä»¶ (<Counter />)
  
  const fiberRoot = createFiberRoot(container);
  // fiberRoot = {
  //   containerInfo: container,  // <div id="__next">
  //   current: HostRootFiber,   // æ ¹ Fiber èŠ‚ç‚¹
  //   ...
  // }
  
  // ========== æ­¥éª¤ 2: å»ºç«‹ DOM â†” Fiber å…³è” ==========
  linkDOMToFiber(container, fiberRoot, element);
  
  // è¯¦ç»†è¿‡ç¨‹ï¼š
  function linkDOMToFiber(domNode, fiberRoot, element) {
    // 2.1 åˆ›å»ºå®¢æˆ·ç«¯ç»„ä»¶æ ‘ï¼ˆFiber æ ‘ï¼‰
    const clientFiberTree = createFiberTree(element);
    // clientFiberTree = {
    //   type: Counter,
    //   child: {
    //     type: 'div',
    //     child: {
    //       type: 'h1',
    //       sibling: {
    //         type: 'button',
    //         props: { onClick: handler }
    //       }
    //     }
    //   }
    // }
    
    // 2.2 è·å–æœåŠ¡ç«¯ DOM æ ‘
    const serverDOMTree = domNode;  // <div id="__next">...</div>
    
    // 2.3 é€’å½’å»ºç«‹å…³è”
    function linkRecursive(domNode, fiberNode) {
      // å»ºç«‹åŒå‘å…³è”
      fiberNode.stateNode = domNode;      // Fiber â†’ DOM
      domNode.__reactFiber = fiberNode;   // DOM â†’ Fiber
      
      // å¤„ç†å­èŠ‚ç‚¹
      let childDOM = domNode.firstChild;
      let childFiber = fiberNode.child;
      
      while (childDOM && childFiber) {
        linkRecursive(childDOM, childFiber);
        childDOM = childDOM.nextSibling;
        childFiber = childFiber.sibling;
      }
    }
    
    // 2.4 ä»æ ¹èŠ‚ç‚¹å¼€å§‹å…³è”
    linkRecursive(serverDOMTree, clientFiberTree);
    
    // 2.5 æ›´æ–° Fiber æ ¹èŠ‚ç‚¹
    fiberRoot.current = clientFiberTree;
  }
  
  // ========== æ­¥éª¤ 3: åˆå§‹åŒ–ç»„ä»¶çŠ¶æ€ ==========
  initializeState(fiberRoot);
  
  function initializeState(fiberRoot) {
    // 3.1 éå† Fiber æ ‘ï¼Œæ‰¾åˆ°æ‰€æœ‰ç»„ä»¶èŠ‚ç‚¹
    function traverseFiber(fiberNode) {
      if (typeof fiberNode.type === 'function') {
        // è¿™æ˜¯ä¸€ä¸ªç»„ä»¶èŠ‚ç‚¹
        // 3.2 åˆå§‹åŒ– useState
        const hooks = fiberNode.memoizedState;
        hooks.forEach(hook => {
          if (hook.type === 'useState') {
            hook.state = hook.initialState;  // count = 0
            hook.setter = createSetter(hook);  // setCount
          }
        });
      }
      
      // é€’å½’å¤„ç†å­èŠ‚ç‚¹
      if (fiberNode.child) {
        traverseFiber(fiberNode.child);
      }
      if (fiberNode.sibling) {
        traverseFiber(fiberNode.sibling);
      }
    });
    
    traverseFiber(fiberRoot.current);
  }
  
  // ========== æ­¥éª¤ 4: æ¢å¤ç»„ä»¶æ ‘ç»“æ„ ==========
  buildFiberTree(fiberRoot, element);
  
  // è¿™ä¸€æ­¥ä¸»è¦æ˜¯ç¡®ä¿ Fiber æ ‘ç»“æ„å®Œæ•´
  // åŒ…æ‹¬ childã€siblingã€return ç­‰æŒ‡é’ˆ
  
  // ========== æ­¥éª¤ 5: æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ ==========
  attachEventListeners(fiberRoot);
  
  function attachEventListeners(fiberRoot) {
    // 5.1 éå† Fiber æ ‘ï¼Œæ‰¾åˆ°æ‰€æœ‰ DOM èŠ‚ç‚¹
    function traverseFiber(fiberNode) {
      if (fiberNode.stateNode && fiberNode.stateNode.nodeType === 1) {
        // è¿™æ˜¯ä¸€ä¸ª DOM èŠ‚ç‚¹
        const domNode = fiberNode.stateNode;
        const props = fiberNode.props;
        
        // 5.2 æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        if (props.onClick) {
          domNode.addEventListener('click', props.onClick);
        }
        if (props.onChange) {
          domNode.addEventListener('input', props.onChange);
        }
        // ... å…¶ä»–äº‹ä»¶
      }
      
      // é€’å½’å¤„ç†å­èŠ‚ç‚¹
      if (fiberNode.child) {
        traverseFiber(fiberNode.child);
      }
      if (fiberNode.sibling) {
        traverseFiber(fiberNode.sibling);
      }
    }
    
    traverseFiber(fiberRoot.current);
  }
  
  // ========== æ­¥éª¤ 6: å¤„ç†å‰¯ä½œç”¨ ==========
  scheduleEffects(fiberRoot);
  
  function scheduleEffects(fiberRoot) {
    // 6.1 æ”¶é›†æ‰€æœ‰ useEffect
    const effects = [];
    function collectEffects(fiberNode) {
      if (fiberNode.updateQueue) {
        fiberNode.updateQueue.forEach(update => {
          if (update.effectTag === 'useEffect') {
            effects.push(update);
          }
        });
      }
      
      if (fiberNode.child) collectEffects(fiberNode.child);
      if (fiberNode.sibling) collectEffects(fiberNode.sibling);
    }
    
    collectEffects(fiberRoot.current);
    
    // 6.2 è°ƒåº¦æ‰§è¡Œ
    effects.forEach(effect => {
      scheduleEffect(effect);
    });
  }
  
  return fiberRoot;
}
```

## ğŸ“Š æ•°æ®æµå›¾ç¤º

### æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯

```
æœåŠ¡ç«¯æ¸²æŸ“:
  <Counter /> ç»„ä»¶
    â†“
  ç”Ÿæˆ HTML:
    <div id="__next">
      <div>
        <h1>Counter</h1>
        <button>Count: 0</button>
      </div>
    </div>
    â†“
  å‘é€ç»™å®¢æˆ·ç«¯
```

### å®¢æˆ·ç«¯æ°´åˆ

```
å®¢æˆ·ç«¯æ¥æ”¶:
  HTML DOM æ ‘
    â†“
  React ä»£ç :
    <Counter /> ç»„ä»¶
    â†“
  åˆ›å»º Fiber æ ‘:
    {
      type: Counter,
      child: {
        type: 'div',
        child: {
          type: 'h1',
          sibling: {
            type: 'button',
            props: { onClick: handler }
          }
        }
      }
    }
    â†“
  å»ºç«‹å…³è”:
    DOM èŠ‚ç‚¹ â†” Fiber èŠ‚ç‚¹
    â†“
  åˆå§‹åŒ–çŠ¶æ€:
    { count: 0 }
    â†“
  æ·»åŠ äº‹ä»¶:
    button.addEventListener('click', handler)
    â†“
  å®Œæˆæ°´åˆ âœ…
```

## ğŸ”‘ å…³é”®ç†è§£ç‚¹

### 1. container æ˜¯æœåŠ¡ç«¯ DOM

```javascript
// container ä¸æ˜¯å®¢æˆ·ç«¯ç»„ä»¶å…¥å£
// è€Œæ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„ DOM å®¹å™¨

const container = document.getElementById('__next');
// container = <div id="__next">...</div>  // æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML
```

### 2. createFiberRoot åˆ›å»ºç©ºçš„ Fiber æ ¹

```javascript
// createFiberRoot åˆ›å»ºçš„æ˜¯ç©ºçš„ Fiber æ ¹èŠ‚ç‚¹
// è¿˜æ²¡æœ‰å…³è”ä»»ä½•ç»„ä»¶

const fiberRoot = createFiberRoot(container);
// fiberRoot.current = HostRootFiber  // ç©ºçš„æ ¹èŠ‚ç‚¹
```

### 3. linkDOMToFiber å»ºç«‹å…³è”

```javascript
// linkDOMToFiber ä¸æ˜¯"é‡æ–°ä¿®æ”¹" Fiber æ ‘
// è€Œæ˜¯å°†æœåŠ¡ç«¯ DOM å’Œå®¢æˆ·ç«¯ç»„ä»¶æ ‘å…³è”èµ·æ¥

// è¿‡ç¨‹ï¼š
// 1. éå†æœåŠ¡ç«¯ DOM æ ‘
// 2. åŒæ—¶éå†å®¢æˆ·ç«¯ç»„ä»¶æ ‘ï¼ˆä» element åˆ›å»ºï¼‰
// 3. å»ºç«‹ä¸€ä¸€å¯¹åº”å…³ç³»

// ç»“æœï¼š
// æ¯ä¸ª DOM èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ Fiber èŠ‚ç‚¹
// æ¯ä¸ª Fiber èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ DOM èŠ‚ç‚¹
```

### 4. element æ˜¯å®¢æˆ·ç«¯ç»„ä»¶å…¥å£

```javascript
// element æ˜¯å®¢æˆ·ç«¯ React ç»„ä»¶çš„å…¥å£
// ä¾‹å¦‚ï¼š<Counter />

const element = <Counter />;
// element = {
//   type: Counter,
//   props: {},
//   ...
// }

// React ä»è¿™ä¸ª element åˆ›å»º Fiber æ ‘
const fiberTree = createFiberTree(element);
```

## ğŸ¯ æ€»ç»“

### å®Œæ•´æµç¨‹

1. **æœåŠ¡ç«¯è¿”å› HTML**ï¼šåŒ…å«é™æ€ DOM ç»“æ„
2. **å®¢æˆ·ç«¯æ¥æ”¶ HTML**ï¼šæµè§ˆå™¨è§£ææˆ DOM æ ‘
3. **createFiberRoot(container)**ï¼šåˆ›å»ºç©ºçš„ Fiber æ ¹èŠ‚ç‚¹
   - `container` æ˜¯æœåŠ¡ç«¯ DOM å®¹å™¨
   - åˆ›å»ºç©ºçš„ Fiber æ ¹èŠ‚ç‚¹
4. **linkDOMToFiber(container, fiberRoot, element)**ï¼š
   - ä» `element` åˆ›å»ºå®¢æˆ·ç«¯ Fiber æ ‘
   - å°†æœåŠ¡ç«¯ DOM æ ‘å’Œå®¢æˆ·ç«¯ Fiber æ ‘å…³è”èµ·æ¥
   - å»ºç«‹åŒå‘å¼•ç”¨å…³ç³»
5. **åˆå§‹åŒ–çŠ¶æ€**ï¼šæ¢å¤ useState çš„çŠ¶æ€
6. **æ·»åŠ äº‹ä»¶**ï¼šç»‘å®šäº‹ä»¶ç›‘å¬å™¨
7. **å¤„ç†å‰¯ä½œç”¨**ï¼šè°ƒåº¦ useEffect

### å…³é”®ç†è§£

- `container`ï¼šæœåŠ¡ç«¯æ¸²æŸ“çš„ DOM å®¹å™¨
- `element`ï¼šå®¢æˆ·ç«¯ React ç»„ä»¶å…¥å£
- `createFiberRoot`ï¼šåˆ›å»ºç©ºçš„ Fiber æ ¹èŠ‚ç‚¹
- `linkDOMToFiber`ï¼šå»ºç«‹ DOM â†” Fiber å…³è”ï¼ˆä¸æ˜¯ä¿®æ”¹ï¼Œæ˜¯å…³è”ï¼‰

æ•´ä¸ªè¿‡ç¨‹æ˜¯å°†**æœåŠ¡ç«¯çš„é™æ€ HTML** å’Œ**å®¢æˆ·ç«¯çš„ React ç»„ä»¶**å…³è”èµ·æ¥ï¼Œè®©é™æ€ HTML å˜æˆå¯äº¤äº’çš„ React åº”ç”¨ï¼

